{% extends "base.html" %}

{% block title %}{{ t('chat.title') }} - {{ project.project_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>üí¨ {{ t('chat.title') }}</h1>
        <p class="subtitle">{{ project.project_name }}</p>
    </div>
    <div class="header-actions">
        <a href="/project/{{ project_id }}" class="btn btn-secondary">‚Üê {{ t('chat.back') }}</a>
    </div>
</div>

{% if kb_facts == 0 %}
<div class="alert alert-warning">
    ‚ö†Ô∏è <strong>{{ t('chat.no_kb_warning') }}</strong> {{ t('chat.no_kb_hint') }}
    <a href="/project/{{ project_id }}" style="text-decoration: underline;">{{ t('chat.go_dashboard') }}</a> {{ t('chat.process_first') }}
</div>
{% endif %}

<div class="chat-container">
    <!-- User Role Selector -->
    <div class="chat-sidebar">
        <h3>{{ t('chat.your_role') }}</h3>
        <select id="user-role" class="form-control">
            <option value="business_analyst">{{ t('chat.role_ba') }}</option>
            <option value="process_owner">{{ t('chat.role_po') }}</option>
            <option value="sme">{{ t('chat.role_sme') }}</option>
            <option value="developer">{{ t('chat.role_dev') }}</option>
        </select>

        <div class="chat-info">
            <h4>{{ t('chat.about_title') }}</h4>
            <p>{{ t('chat.about_desc') }}</p>
            <ul>
                <li>‚úÖ {{ t('chat.feature_knowledge') }}</li>
                <li>‚úÖ {{ t('chat.feature_role') }}</li>
                <li>‚úÖ {{ t('chat.feature_gap') }}</li>
                <li>‚úÖ {{ t('chat.feature_session') }}</li>
            </ul>
        </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-main">
        <div id="chat-messages" class="chat-messages">
            {% if messages %}
                {% for turn in messages %}
                <div class="message user-message">
                    <div class="message-header">
                        <span class="message-author">{{ turn.user_id }}</span>
                        <span class="message-time">{{ turn.timestamp.split('T')[1].split('.')[0] if 'T' in turn.timestamp else turn.timestamp }}</span>
                    </div>
                    <div class="message-content">{{ turn.user_message }}</div>
                </div>
                <div class="message agent-message">
                    <div class="message-header">
                        <span class="message-author">ü§ñ {{ t('chat.agent') }}</span>
                        <span class="message-time">{{ turn.timestamp.split('T')[1].split('.')[0] if 'T' in turn.timestamp else turn.timestamp }}</span>
                    </div>
                    <div class="message-content">{{ turn.agent_response }}</div>
                </div>
                {% endfor %}
            {% else %}
            <div class="chat-empty">
                <div class="empty-icon">üí¨</div>
                <h3>{{ t('chat.empty_title') }}</h3>
                <p>{{ t('chat.empty_desc') }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Input Area -->
        <form id="chat-form" class="chat-input">
            <input
                type="text"
                id="message-input"
                placeholder="{{ t('chat.placeholder') }}"
                autocomplete="off"
                required
            >
            <button type="submit" class="btn btn-primary">{{ t('chat.send') }}</button>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const PROJECT_ID = "{{ project_id }}";
const CHAT_T = {
    you: "{{ t('chat.you') }}",
    agent: "{{ t('chat.agent') }}"
};
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const userRoleSelect = document.getElementById('user-role');

// Phase-to-API-endpoint mapping for deliverable generation
const PHASE_ENDPOINTS = {
    'standardization': `/api/projects/${PROJECT_ID}/generate`,
    'optimization': `/api/projects/${PROJECT_ID}/generate-optimization`,
    'digitization': `/api/projects/${PROJECT_ID}/generate-digitization`,
    'automation': `/api/projects/${PROJECT_ID}/generate-automation`,
    'autonomization': `/api/projects/${PROJECT_ID}/generate-autonomization`,
};

async function triggerGeneration(phase) {
    const endpoint = PHASE_ENDPOINTS[phase];
    if (!endpoint) {
        addMessage('Error: Unknown phase for generation.', false);
        return;
    }

    addMessage('‚è≥ Generating deliverables... This may take 1-2 minutes.', false);

    try {
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();

        if (response.ok) {
            const fileCount = Object.keys(data.files_saved || {}).length;
            const completeness = data.overall_completeness || 0;
            addMessage(
                `‚úÖ ${fileCount} deliverables generated (${completeness}% complete). ` +
                `<a href="/project/${PROJECT_ID}/deliverables" style="text-decoration:underline">View deliverables ‚Üí</a>`,
                false
            );
        } else {
            addMessage(`‚ùå Generation failed: ${data.error || 'Unknown error'}`, false);
        }
    } catch (error) {
        addMessage(`‚ùå Generation error: ${error.message}`, false);
    }
}

// Auto-scroll to bottom
function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Add message to chat
function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user-message' : 'agent-message'}`;

    const now = new Date();
    const time = now.toTimeString().split(' ')[0];

    messageDiv.innerHTML = `
        <div class="message-header">
            <span class="message-author">${isUser ? CHAT_T.you : 'ü§ñ ' + CHAT_T.agent}</span>
            <span class="message-time">${time}</span>
        </div>
        <div class="message-content">${content}</div>
    `;

    // Remove empty state if present
    const emptyState = chatMessages.querySelector('.chat-empty');
    if (emptyState) {
        emptyState.remove();
    }

    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Handle form submission
chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    const message = messageInput.value.trim();
    if (!message) return;

    const userRole = userRoleSelect.value;

    // Add user message immediately
    addMessage(message, true);
    messageInput.value = '';

    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message agent-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-header">
            <span class="message-author">ü§ñ ${CHAT_T.agent}</span>
        </div>
        <div class="message-content">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;
    chatMessages.appendChild(typingDiv);
    scrollToBottom();

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: message,
                user_id: 'web-user',
                user_role: userRole
            })
        });

        const data = await response.json();

        // Remove typing indicator
        typingDiv.remove();

        if (response.ok) {
            addMessage(data.response, false);

            // Auto-trigger deliverable generation when agent signals readiness
            if (data.trigger_generation && data.phase) {
                triggerGeneration(data.phase);
            }
        } else {
            addMessage(`Error: ${data.error}`, false);
        }
    } catch (error) {
        typingDiv.remove();
        addMessage(`Error: ${error.message}`, false);
    }
});

// Auto-start conversation if no messages exist
async function autoStartConversation() {
    const emptyState = chatMessages.querySelector('.chat-empty');
    if (!emptyState) return; // Already has messages

    const userRole = userRoleSelect.value;

    // Show typing indicator
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message agent-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-header">
            <span class="message-author">ü§ñ ${CHAT_T.agent}</span>
        </div>
        <div class="message-content">
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
            <span class="typing-dot"></span>
        </div>
    `;

    // Remove empty state first
    emptyState.remove();
    chatMessages.appendChild(typingDiv);

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: '__START__',
                user_id: 'web-user',
                user_role: userRole
            })
        });

        const data = await response.json();

        // Remove typing indicator
        typingDiv.remove();

        if (response.ok) {
            addMessage(data.response, false);
        } else {
            addMessage(`Error: ${data.error}`, false);
        }
    } catch (error) {
        typingDiv.remove();
        addMessage(`Error: ${error.message}`, false);
    }
}

// Initial scroll and auto-start
scrollToBottom();
// Wait a moment for page to fully render, then auto-start
setTimeout(autoStartConversation, 500);
</script>
{% endblock %}
