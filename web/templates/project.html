{% extends "base.html" %}

{% block title %}{{ project.project_name }} - Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ project.project_name }}</h1>
        <p class="subtitle">{{ t('project.id_label') }} {{ project_id }}</p>
        {% if project.description %}
        <p class="project-description">{{ project.description }}</p>
        {% endif %}
    </div>
    <div class="header-actions">
        <a href="/project/{{ project_id }}/chat" class="btn btn-primary">üí¨ {{ t('project.chat') }}</a>
        <a href="/project/{{ project_id }}/deliverables" class="btn btn-secondary">üìÑ {{ t('project.deliverables_btn') }}</a>
    </div>
</div>

<!-- Warning if no knowledge base exists -->
{% if uploaded_files > 0 and kb_facts == 0 %}
<div class="alert alert-warning">
    ‚ö†Ô∏è <strong>{{ t('project.files_not_processed') }}</strong> {{ t('project.files_not_processed_hint') }}
</div>
{% endif %}

<!-- Status Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìö</div>
        <div class="stat-content">
            <div class="stat-label">{{ t('project.knowledge_base') }}</div>
            <div class="stat-value">{{ kb_facts }} {{ t('project.facts_unit') }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üìÅ</div>
        <div class="stat-content">
            <div class="stat-label">{{ t('project.uploaded_files') }}</div>
            <div class="stat-value">{{ uploaded_files }} {{ t('project.files_unit') }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-content">
            <div class="stat-label">{{ t('project.api_calls') }}</div>
            <div class="stat-value">{{ api_calls }} {{ t('project.calls_unit') }}</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <div class="stat-label">{{ t('project.total_cost') }}</div>
            <div class="stat-value">${{ "%.4f"|format(total_cost) }}</div>
        </div>
    </div>
</div>

<!-- Phase Progress -->
<div class="section">
    <h2>üìä {{ t('project.phase_progress') }}</h2>
    <div class="phase-timeline">
        {% for phase_name, phase_data in project.phases.items() %}
        <div class="phase-item {% if phase_name == project.current_phase %}active{% elif phase_data.status == 'complete' %}completed{% endif %}">
            <div class="phase-number">{{ loop.index }}</div>
            <div class="phase-info">
                <div class="phase-name">{{ phase_name|title }}</div>
                <div class="phase-status">
                    {% if phase_data.status == 'complete' %}
                    <span class="status-badge status-completed">‚úì {{ t('project.completed') }}</span>
                    {% elif phase_name == project.current_phase %}
                    <span class="status-badge status-active">‚Üí {{ t('project.in_progress') }}</span>
                    {% else %}
                    <span class="status-badge status-locked">üîí {{ t('project.locked') }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Knowledge & Progress -->
{% if kb_facts > 0 or gap_data %}
<div class="section">
    <h2>üìñ {{ t('project.knowledge_progress') }}</h2>

    {% if kb_breakdown %}
    <div class="subsection">
        <h3>{{ t('project.what_learned') }}</h3>
        <div class="knowledge-grid">
            {% for category, facts in kb_breakdown.items() %}
            <div class="knowledge-card">
                <div class="knowledge-header">
                    <strong>{{ category|replace('_', ' ')|title }}</strong>
                    <span class="badge">{{ facts|length }}</span>
                </div>
                <ul class="fact-list">
                    {% for fact in facts[:5] %}
                    <li>{{ fact }}</li>
                    {% endfor %}
                    {% if facts|length > 5 %}
                    <li class="fact-more">{{ t('project.and_more', count=facts|length - 5) }}</li>
                    {% endif %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if gap_data %}
    <div class="subsection">
        <h3>{{ t('project.deliverable_completeness') }}</h3>
        <div class="completeness-summary">
            <div class="overall-progress">
                <div class="progress-label">{{ t('project.overall_progress') }}</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ gap_data.overall_completeness }}%"></div>
                </div>
                <div class="progress-value">{{ gap_data.overall_completeness }}%</div>
            </div>
        </div>

        <div class="gap-cards">
            {% for gap in gap_data.deliverable_gaps %}
            <div class="gap-card">
                <div class="gap-header">
                    <strong>{{ gap.deliverable }}</strong>
                    <span class="completeness-badge {% if gap.completeness_pct >= 80 %}good{% elif gap.completeness_pct >= 50 %}warning{% else %}critical{% endif %}">
                        {{ gap.completeness_pct }}%
                    </span>
                </div>

                {% if gap.missing_fields %}
                <div class="gap-missing">
                    <div class="gap-section-title">‚ùå {{ t('project.still_missing') }}</div>
                    <ul class="gap-list">
                        {% for field in gap.missing_fields[:3] %}
                        <li>{{ field|replace('_', ' ')|title }}</li>
                        {% endfor %}
                        {% if gap.missing_fields|length > 3 %}
                        <li>{{ t('project.and_more', count=gap.missing_fields|length - 3) }}</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                {% if gap.present_fields %}
                <div class="gap-complete">
                    <div class="gap-section-title">‚úÖ {{ t('project.already_have') }}</div>
                    <ul class="gap-list">
                        {% for field in gap.present_fields[:3] %}
                        <li>{{ field|replace('_', ' ')|title }}</li>
                        {% endfor %}
                        {% if gap.present_fields|length > 3 %}
                        <li>{{ t('project.and_more', count=gap.present_fields|length - 3) }}</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="section">
    <h2>üöÄ {{ t('project.actions') }}</h2>
    <div class="actions-grid">
        <!-- Upload Files -->
        <div class="action-card">
            <h3>üì§ {{ t('project.upload_title') }}</h3>
            <p>{{ t('project.upload_desc') }}</p>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="file-input" name="file" accept=".pdf,.docx,.txt,.csv,.json,.png,.jpg,.jpeg" multiple>
                    <label for="file-input" class="file-label">{{ t('project.choose_files') }}</label>
                    <div id="file-list"></div>
                </div>
                <button type="submit" class="btn btn-primary">{{ t('project.upload_btn') }}</button>
            </form>
            <div id="upload-status"></div>
        </div>

        <!-- Process Knowledge -->
        <div class="action-card">
            <h3>üß† {{ t('project.process_title') }}</h3>
            <p>{{ t('project.process_desc') }}</p>
            <button id="process-btn" class="btn btn-primary">{{ t('project.process_btn') }}</button>
            <div id="process-status"></div>
        </div>

        <!-- Analyze Gaps -->
        <div class="action-card">
            <h3>üîç {{ t('project.analyze_title') }}</h3>
            <p>{{ t('project.analyze_desc') }}</p>
            <button id="analyze-btn" class="btn btn-primary">{{ t('project.analyze_btn') }}</button>
            <div id="analyze-status"></div>
        </div>

        <!-- Generate Deliverables -->
        <div class="action-card">
            <h3>üìã {{ t('project.generate_title') }}</h3>
            <p>{{ t('project.generate_desc') }}</p>
            <button id="generate-btn" class="btn btn-primary">{{ t('project.generate_btn') }}</button>
            <div id="generate-status"></div>
        </div>

        <!-- Gate Review -->
        <div class="action-card">
            <h3>‚úÖ {{ t('project.gate_title') }}</h3>
            <p>{{ t('project.gate_desc') }}</p>
            <button id="gate-review-btn" class="btn btn-primary">{{ t('project.gate_btn') }}</button>
            <div id="gate-review-status"></div>
        </div>

        <!-- Generate Optimization Deliverables -->
        <div class="action-card">
            <h3>üéØ {{ t('project.optimization_title') }}</h3>
            <p>{{ t('project.optimization_desc') }}</p>
            <button id="generate-optimization-btn" class="btn btn-primary">{{ t('project.optimization_btn') }}</button>
            <div id="optimization-status"></div>
        </div>
    </div>
</div>

<!-- Current Phase Deliverables -->
<div class="section">
    <h2>üìÑ {{ t('project.current_deliverables') }}</h2>
    {% set current_phase_data = project.phases[project.current_phase] %}
    <div class="deliverables-list">
        {% for deliverable_name, deliverable in current_phase_data.deliverables.items() %}
        <div class="deliverable-item">
            <div class="deliverable-icon">{% if deliverable.completed %}‚úÖ{% else %}‚è≥{% endif %}</div>
            <div class="deliverable-info">
                <div class="deliverable-name">{{ deliverable_name|replace('_', ' ')|title }}</div>
                <div class="deliverable-meta">
                    <span class="deliverable-status">{{ t('project.status_completed') if deliverable.completed else t('project.status_pending') }}</span>
                    {% if deliverable.completed_at %}
                    <span class="deliverable-date">‚Ä¢ {{ deliverable.completed_at.split('T')[0] }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const PROJECT_ID = "{{ project_id }}";
const T = {
    select_file: "{{ t('js.select_file') }}",
    uploading: "{{ t('js.uploading') }}",
    uploaded: "{{ t('js.uploaded') }}",
    processing: "{{ t('js.processing') }}",
    extracting: "{{ t('js.extracting') }}",
    processed_success: "{{ t('js.processed_success') }}",
    process_btn: "{{ t('project.process_btn') }}",
    analyzing: "{{ t('js.analyzing') }}",
    running_analysis: "{{ t('js.running_analysis') }}",
    analysis_complete: "{{ t('js.analysis_complete') }}",
    analyze_btn: "{{ t('project.analyze_btn') }}",
    confirm_generate: "{{ t('js.confirm_generate') }}",
    generating: "{{ t('js.generating') }}",
    generating_info: "{{ t('js.generating_info') }}",
    generated_success: "{{ t('js.generated_success') }}",
    generate_btn: "{{ t('project.generate_btn') }}",
    confirm_gate: "{{ t('js.confirm_gate') }}",
    evaluating: "{{ t('js.evaluating') }}",
    evaluating_info: "{{ t('js.evaluating_info') }}",
    gate_passed: "{{ t('js.gate_passed') }}",
    gate_conditional: "{{ t('js.gate_conditional') }}",
    gate_failed: "{{ t('js.gate_failed') }}",
    overall_score: "{{ t('js.overall_score') }}",
    threshold: "{{ t('js.threshold') }}",
    details: "{{ t('js.details') }}",
    gate_btn: "{{ t('project.gate_btn') }}",
    confirm_optimization: "{{ t('js.confirm_optimization') }}",
    generating_optimization: "{{ t('js.generating_optimization') }}",
    optimization_success: "{{ t('js.optimization_success') }}",
    optimization_btn: "{{ t('project.optimization_btn') }}"
};

// File upload handling
document.getElementById('file-input').addEventListener('change', function(e) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    Array.from(e.target.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.textContent = file.name;
        fileList.appendChild(fileItem);
    });
});

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file-input');
    const statusDiv = document.getElementById('upload-status');

    if (!fileInput.files.length) {
        statusDiv.innerHTML = `<div class="alert alert-error">${T.select_file}</div>`;
        return;
    }

    statusDiv.innerHTML = `<div class="alert alert-info">${T.uploading}</div>`;

    for (const file of fileInput.files) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`/api/projects/${PROJECT_ID}/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                statusDiv.innerHTML += `<div class="alert alert-success">‚úì ${file.name} ${T.uploaded}</div>`;
            } else {
                statusDiv.innerHTML += `<div class="alert alert-error">‚úó ${file.name}: ${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML += `<div class="alert alert-error">‚úó ${file.name}: ${error.message}</div>`;
        }
    }

    fileInput.value = '';
    document.getElementById('file-list').innerHTML = '';
    setTimeout(() => location.reload(), 2000);
});

// Process knowledge
document.getElementById('process-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('process-status');

    btn.disabled = true;
    btn.textContent = T.processing;
    statusDiv.innerHTML = `<div class="alert alert-info">${T.extracting}</div>`;

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/process`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const count = data.knowledge_base?.facts?.length || 0;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì ${T.processed_success.replace('{count}', count)}</div>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = T.process_btn;
    }
});

// Analyze gaps
document.getElementById('analyze-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('analyze-status');

    btn.disabled = true;
    btn.textContent = T.analyzing;
    statusDiv.innerHTML = `<div class="alert alert-info">${T.running_analysis}</div>`;

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/analyze`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const pct = data.current_phase?.completeness_percent || 0;
            const count = data.current_phase?.missing_count || 0;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì ${T.analysis_complete.replace('{pct}', pct).replace('{count}', count)}</div>`;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = T.analyze_btn;
    }
});

// Generate deliverables
document.getElementById('generate-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('generate-status');

    if (!confirm(T.confirm_generate)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = T.generating;
    statusDiv.innerHTML = `<div class="alert alert-info">${T.generating_info}</div>`;

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/generate`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const count = Object.values(data).filter(v => v.status === 'success').length;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì ${T.generated_success.replace('{count}', count)}</div>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = T.generate_btn;
    }
});

// Gate Review
document.getElementById('gate-review-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('gate-review-status');

    if (!confirm(T.confirm_gate)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = T.evaluating;
    statusDiv.innerHTML = `<div class="alert alert-info">${T.evaluating_info}</div>`;

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/gate-review`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ phase: 'standardization' })
        });
        const data = await response.json();

        if (response.ok) {
            const decision = data.decision;
            const score = data.score;
            const thresh = data.threshold;
            const feedbackHtml = (data.feedback || []).map(item => `<li>${item}</li>`).join('');

            if (decision === 'PASS') {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ ${T.gate_passed}</strong><br>
                        ${T.overall_score}: ${score}% (${T.threshold}: ${thresh}%)<br>
                        ${data.summary || ''}<br><br>
                        <strong>${T.details}:</strong>
                        <ul>${feedbackHtml}</ul>
                    </div>
                `;
                setTimeout(() => location.reload(), 3000);
            } else if (decision === 'CONDITIONAL_PASS') {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è ${T.gate_conditional}</strong><br>
                        ${T.overall_score}: ${score}% (${T.threshold}: ${thresh}%)<br>
                        ${data.summary || ''}<br><br>
                        <strong>${T.details}:</strong>
                        <ul>${feedbackHtml}</ul>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-error">
                        <strong>‚ùå ${T.gate_failed}</strong><br>
                        ${T.overall_score}: ${score}% (${T.threshold}: ${thresh}%)<br>
                        ${data.summary || ''}<br><br>
                        <strong>${T.details}:</strong>
                        <ul>${feedbackHtml}</ul>
                    </div>
                `;
            }
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = T.gate_btn;
    }
});

// Generate Optimization Deliverables
document.getElementById('generate-optimization-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('optimization-status');

    if (!confirm(T.confirm_optimization)) {
        return;
    }

    btn.disabled = true;
    btn.textContent = T.generating;
    statusDiv.innerHTML = `<div class="alert alert-info">${T.generating_optimization}</div>`;

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/generate-optimization`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const count = Object.keys(data.files_saved || {}).length;
            const pct = data.overall_completeness || 0;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì ${T.optimization_success.replace('{count}', count).replace('{pct}', pct)}</div>`;
            setTimeout(() => location.reload(), 3000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = T.optimization_btn;
    }
});
</script>
{% endblock %}
