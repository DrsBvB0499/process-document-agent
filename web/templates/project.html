{% extends "base.html" %}

{% block title %}{{ project.project_name }} - Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>{{ project.project_name }}</h1>
        <p class="subtitle">Project ID: {{ project_id }}</p>
        {% if project.description %}
        <p class="project-description">{{ project.description }}</p>
        {% endif %}
    </div>
    <div class="header-actions">
        <a href="/project/{{ project_id }}/chat" class="btn btn-primary">üí¨ Chat</a>
        <a href="/project/{{ project_id }}/deliverables" class="btn btn-secondary">üìÑ Deliverables</a>
    </div>
</div>

<!-- Warning if no knowledge base exists -->
{% if uploaded_files > 0 and kb_facts == 0 %}
<div class="alert alert-warning">
    ‚ö†Ô∏è <strong>Files uploaded but not processed!</strong> Click "Process Files" below to extract information before chatting with the agent.
</div>
{% endif %}

<!-- Status Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üìö</div>
        <div class="stat-content">
            <div class="stat-label">Knowledge Base</div>
            <div class="stat-value">{{ kb_facts }} facts</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üìÅ</div>
        <div class="stat-content">
            <div class="stat-label">Uploaded Files</div>
            <div class="stat-value">{{ uploaded_files }} files</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-content">
            <div class="stat-label">API Calls</div>
            <div class="stat-value">{{ api_calls }} calls</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <div class="stat-label">Total Cost</div>
            <div class="stat-value">${{ "%.4f"|format(total_cost) }}</div>
        </div>
    </div>
</div>

<!-- Phase Progress -->
<div class="section">
    <h2>üìä Phase Progress</h2>
    <div class="phase-timeline">
        {% for phase_name, phase_data in project.phases.items() %}
        <div class="phase-item {% if phase_name == project.current_phase %}active{% elif phase_data.status == 'complete' %}completed{% endif %}">
            <div class="phase-number">{{ loop.index }}</div>
            <div class="phase-info">
                <div class="phase-name">{{ phase_name|title }}</div>
                <div class="phase-status">
                    {% if phase_data.status == 'complete' %}
                    <span class="status-badge status-completed">‚úì Completed</span>
                    {% elif phase_name == project.current_phase %}
                    <span class="status-badge status-active">‚Üí In Progress</span>
                    {% else %}
                    <span class="status-badge status-locked">üîí Locked</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Knowledge & Progress (NEW!) -->
{% if kb_facts > 0 or gap_data %}
<div class="section">
    <h2>üìñ Knowledge & Progress</h2>

    {% if kb_breakdown %}
    <div class="subsection">
        <h3>What the Agent Has Learned</h3>
        <div class="knowledge-grid">
            {% for category, facts in kb_breakdown.items() %}
            <div class="knowledge-card">
                <div class="knowledge-header">
                    <strong>{{ category|replace('_', ' ')|title }}</strong>
                    <span class="badge">{{ facts|length }}</span>
                </div>
                <ul class="fact-list">
                    {% for fact in facts[:5] %}
                    <li>{{ fact }}</li>
                    {% endfor %}
                    {% if facts|length > 5 %}
                    <li class="fact-more">... and {{ facts|length - 5 }} more</li>
                    {% endif %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if gap_data %}
    <div class="subsection">
        <h3>Deliverable Completeness</h3>
        <div class="completeness-summary">
            <div class="overall-progress">
                <div class="progress-label">Overall Progress</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ gap_data.overall_completeness }}%"></div>
                </div>
                <div class="progress-value">{{ gap_data.overall_completeness }}%</div>
            </div>
        </div>

        <div class="gap-cards">
            {% for gap in gap_data.deliverable_gaps %}
            <div class="gap-card">
                <div class="gap-header">
                    <strong>{{ gap.deliverable }}</strong>
                    <span class="completeness-badge {% if gap.completeness_pct >= 80 %}good{% elif gap.completeness_pct >= 50 %}warning{% else %}critical{% endif %}">
                        {{ gap.completeness_pct }}%
                    </span>
                </div>

                {% if gap.missing_fields %}
                <div class="gap-missing">
                    <div class="gap-section-title">‚ùå Still Missing:</div>
                    <ul class="gap-list">
                        {% for field in gap.missing_fields[:3] %}
                        <li>{{ field|replace('_', ' ')|title }}</li>
                        {% endfor %}
                        {% if gap.missing_fields|length > 3 %}
                        <li>... and {{ gap.missing_fields|length - 3 }} more</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                {% if gap.present_fields %}
                <div class="gap-complete">
                    <div class="gap-section-title">‚úÖ Already Have:</div>
                    <ul class="gap-list">
                        {% for field in gap.present_fields[:3] %}
                        <li>{{ field|replace('_', ' ')|title }}</li>
                        {% endfor %}
                        {% if gap.present_fields|length > 3 %}
                        <li>... and {{ gap.present_fields|length - 3 }} more</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Actions -->
<div class="section">
    <h2>üöÄ Actions</h2>
    <div class="actions-grid">
        <!-- Upload Files -->
        <div class="action-card">
            <h3>üì§ Upload Files</h3>
            <p>Upload process documentation, SOPs, or other materials</p>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <input type="file" id="file-input" name="file" accept=".pdf,.docx,.txt,.csv,.json,.png,.jpg,.jpeg" multiple>
                    <label for="file-input" class="file-label">Choose files...</label>
                    <div id="file-list"></div>
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
            <div id="upload-status"></div>
        </div>

        <!-- Process Knowledge -->
        <div class="action-card">
            <h3>üß† Process Knowledge</h3>
            <p>Extract structured information from uploaded files</p>
            <button id="process-btn" class="btn btn-primary">Process Files</button>
            <div id="process-status"></div>
        </div>

        <!-- Analyze Gaps -->
        <div class="action-card">
            <h3>üîç Analyze Gaps</h3>
            <p>Identify missing information for deliverables</p>
            <button id="analyze-btn" class="btn btn-primary">Run Gap Analysis</button>
            <div id="analyze-status"></div>
        </div>

        <!-- Generate Deliverables -->
        <div class="action-card">
            <h3>üìã Generate Deliverables</h3>
            <p>Create SIPOC, Process Map, Metrics, and more</p>
            <button id="generate-btn" class="btn btn-primary">Generate All</button>
            <div id="generate-status"></div>
        </div>
    </div>
</div>

<!-- Current Phase Deliverables -->
<div class="section">
    <h2>üìÑ Current Phase Deliverables</h2>
    {% set current_phase_data = project.phases[project.current_phase] %}
    <div class="deliverables-list">
        {% for deliverable_name, deliverable in current_phase_data.deliverables.items() %}
        <div class="deliverable-item">
            <div class="deliverable-icon">{% if deliverable.completed %}‚úÖ{% else %}‚è≥{% endif %}</div>
            <div class="deliverable-info">
                <div class="deliverable-name">{{ deliverable_name|replace('_', ' ')|title }}</div>
                <div class="deliverable-meta">
                    <span class="deliverable-status">{{ 'Completed' if deliverable.completed else 'Pending' }}</span>
                    {% if deliverable.completed_at %}
                    <span class="deliverable-date">‚Ä¢ {{ deliverable.completed_at.split('T')[0] }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const PROJECT_ID = "{{ project_id }}";

// File upload handling
document.getElementById('file-input').addEventListener('change', function(e) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';
    Array.from(e.target.files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.textContent = file.name;
        fileList.appendChild(fileItem);
    });
});

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById('file-input');
    const statusDiv = document.getElementById('upload-status');

    if (!fileInput.files.length) {
        statusDiv.innerHTML = '<div class="alert alert-error">Please select at least one file</div>';
        return;
    }

    statusDiv.innerHTML = '<div class="alert alert-info">Uploading...</div>';

    for (const file of fileInput.files) {
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch(`/api/projects/${PROJECT_ID}/upload`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (response.ok) {
                statusDiv.innerHTML += `<div class="alert alert-success">‚úì ${file.name} uploaded</div>`;
            } else {
                statusDiv.innerHTML += `<div class="alert alert-error">‚úó ${file.name}: ${data.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML += `<div class="alert alert-error">‚úó ${file.name}: ${error.message}</div>`;
        }
    }

    fileInput.value = '';
    document.getElementById('file-list').innerHTML = '';
    setTimeout(() => location.reload(), 2000);
});

// Process knowledge
document.getElementById('process-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('process-status');

    btn.disabled = true;
    btn.textContent = 'Processing...';
    statusDiv.innerHTML = '<div class="alert alert-info">Extracting knowledge from files...</div>';

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/process`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì Processed successfully! Extracted ${data.knowledge_base?.facts?.length || 0} facts</div>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Process Files';
    }
});

// Analyze gaps
document.getElementById('analyze-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('analyze-status');

    btn.disabled = true;
    btn.textContent = 'Analyzing...';
    statusDiv.innerHTML = '<div class="alert alert-info">Running gap analysis...</div>';

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/analyze`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const completeness = data.current_phase?.completeness_percent || 0;
            const missing = data.current_phase?.missing_count || 0;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì Analysis complete! Completeness: ${completeness}% (${missing} gaps identified)</div>`;
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Run Gap Analysis';
    }
});

// Generate deliverables
document.getElementById('generate-btn').addEventListener('click', async function() {
    const btn = this;
    const statusDiv = document.getElementById('generate-status');

    if (!confirm('This will generate all deliverables for the Standardization phase. Continue?')) {
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Generating...';
    statusDiv.innerHTML = '<div class="alert alert-info">Generating deliverables... This may take a minute.</div>';

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/generate`, {
            method: 'POST'
        });
        const data = await response.json();

        if (response.ok) {
            const successCount = Object.values(data).filter(v => v.status === 'success').length;
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì Generated ${successCount} deliverables successfully!</div>`;
            setTimeout(() => location.reload(), 2000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Generate All';
    }
});
</script>
{% endblock %}
